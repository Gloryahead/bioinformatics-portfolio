# ===================================================================
# SCRIPT 2: PROCESS SPIKE-IN & MERGE (Corrected Version)
# - Self-contained script for use in a SLURM job.
# - Loads packages, reads the mm10 results, processes spike-in files,
#   merges the data, and saves ALL necessary output files.
# ===================================================================

# --- 1. PACKAGE MANAGEMENT ---
# This block is required because this script runs in its own session.

# Ensure BiocManager is installed
if (!requireNamespace("BiocManager", quietly = TRUE)) {
  install.packages("BiocManager")
}

# Define list of required packages (only need dplyr and magrittr for this part)
cran_packages <- c("dplyr", "magrittr")

# Function to install missing packages
install_if_missing <- function(pkgs, install_func) {
  for (pkg in pkgs) {
    if (!requireNamespace(pkg, quietly = TRUE)) {
      install_func(pkg)
    }
  }
}

# Install any missing packages
install_if_missing(cran_packages, install.packages)


# Load required libraries
suppressPackageStartupMessages({
  library(dplyr)
  library(magrittr)
})


# --- 2. LOAD DATA FROM PREVIOUS STEP ---

# Define paths
projPath_mm10 <- "/path/to/your/project/bowtie2_summary"
projPath_spike <- "/path/to/your/project/bowtie2_summary"
mm10_results_file <- file.path(projPath_mm10, "alignResult_mm10.csv")

# Error handling: Check if the input file from Script 1 exists
if (!file.exists(mm10_results_file)) {
  stop("Execution halted: Input file not found: '", mm10_results_file, "'. Please run Script 1 first.")
}

# Load the alignment results generated by the first script
alignResult <- read.csv(mm10_results_file)


# --- 3. PROCESS SPIKE-IN (E. coli) ALIGNMENTS ---

# Automatically find all .txt files
file_list_spike <- list.files(path = projPath_spike, pattern = "\\.txt$")

# Error Handling
if (length(file_list_spike) == 0) {
  stop("Execution halted: No '.txt' spike-in files found in directory: '", projPath_spike, "'")
}

# Dynamically create sample list
sampleList_spike <- tools::file_path_sans_ext(file_list_spike)

# Initialize data frame
spikeAlign <- data.frame() 

# Loop and process files
for(hist in sampleList_spike){
  file_path <- file.path(projPath_spike, paste0(hist, ".txt"))
  spikeRes <- read.table(file_path, header = FALSE, fill = TRUE)
  alignRate <- substr(spikeRes$V1[6], 1, nchar(as.character(spikeRes$V1[6]))-1)
  histInfo <- strsplit(hist, "_")[[1]]
  
  tempResult <- data.frame(
    Targets = histInfo[1], 
    Alignment = histInfo[2], 
    SequencingDepth = as.numeric(as.character(spikeRes$V1[1])), 
    MappedFragNum_spikeIn = as.numeric(as.character(spikeRes$V1[4])) + as.numeric(as.character(spikeRes$V1[5])), 
    AlignmentRate_spikeIn = as.numeric(alignRate)
  )
  
  spikeAlign <- rbind(spikeAlign, tempResult)
}


# --- 4. SAVE INTERMEDIATE AND FINAL OUTPUTS ---

# **FIX ADDED HERE:** Save the spikeAlign data frame before merging.
# This is the file that Script 3 (the plotting script) needs.
output_spike_file <- file.path(projPath_spike, "alignResult_spikeIn.csv")
write.csv(spikeAlign, file = output_spike_file, row.names = FALSE)
print(paste("Spike-in alignment results successfully saved to:", output_spike_file))


# Now, continue with the merge operation
alignSummary <- left_join(alignResult, spikeAlign, by = c("Targets", "SequencingDepth"))

# Define output paths for the final merged summary
output_summary_path_ecoli <- file.path(projPath_spike, "alignSummary_merged.csv")
output_summary_path_mm10 <- file.path(projPath_mm10, "alignSummary_merged.csv")

# Write the final merged summary to both directories
write.csv(alignSummary, file = output_summary_path_ecoli, row.names = FALSE)
write.csv(alignSummary, file = output_summary_path_mm10, row.names = FALSE)

print(paste("Final merged summary has been saved to:", output_summary_path_ecoli))
print(paste("Final merged summary has also been saved to:", output_summary_path_mm10))
print("--- Script 2 Complete ---")
